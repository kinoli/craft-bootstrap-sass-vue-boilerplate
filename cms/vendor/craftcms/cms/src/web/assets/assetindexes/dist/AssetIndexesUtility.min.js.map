{"version":3,"sources":["assetindexes/src/AssetIndexesUtility.js"],"names":["$","Craft","AssetIndexesUtility","Garnish","Base","extend","$trigger","$form","completedActions","loadingActions","queue","cacheImages","formId","sessionId","init","$status","addListener","this","onSubmit","progressBar","ev","preventDefault","hasClass","resetProgressBar","totalActions","ProgressBar","$progressBarStatus","velocity","opacity","postData","removeClass","params","expandPostArray","postActionRequest","complete","response","indexingData","getPostData","start","volumeData","requestCounter","push","volumes","i","total","process","volumeId","processIndexing","finishIndexing","addClass","trigger","updateProgressBar","$allDone","setItemCount","setProcessedItemCount","maxConcurrentActions","alert","shift","error","bind","data","type","$modal","appendTo","$bod","$body","html","confirm","$buttons","$footer","modal","hide","showDelete","onComplete","class","text","t","Modal","hideOnShadeClick","settings","onHide","finish","noop","proxy","showConfirmDialog","$progressBar","overview","hideProgressBar","duration","css","jQuery"],"mappings":"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","file":"AssetIndexesUtility.min.js","sourcesContent":["(function($) {\n    Craft.AssetIndexesUtility = Garnish.Base.extend({\n        $trigger: null,\n        $form: null,\n\n        totalActions: null,\n        completedActions: null,\n        loadingActions: null,\n        queue: null,\n\n        cacheImages: false,\n        sessionId: null,\n\n        init: function(formId) {\n            this.$form = $('#' + formId);\n            this.$trigger = $('input.submit', this.$form);\n            this.$status = $('.utility-status', this.$form);\n\n            this.addListener(this.$form, 'submit', 'onSubmit');\n        },\n\n        onSubmit: function(ev) {\n            ev.preventDefault();\n\n            if (!this.$trigger.hasClass('disabled')) {\n                if (!this.progressBar) {\n                    this.progressBar = new Craft.ProgressBar(this.$status, true);\n                } else {\n                    this.progressBar.resetProgressBar();\n                }\n\n                this.totalActions = 0;\n                this.loadingActions = 0;\n                this.completedActions = 0;\n                this.queue = [];\n\n                this.progressBar.$progressBar.removeClass('hidden');\n                this.progressBar.$progressBarStatus.removeClass('hidden');\n\n                this.progressBar.$progressBar.velocity('stop').velocity({\n                    opacity: 1\n                }, {\n                    complete: $.proxy(function() {\n                        var postData = Garnish.getPostData(this.$form),\n                            params = Craft.expandPostArray(postData);\n                        params.start = true;\n\n                        this.cacheImages = params.cacheImages;\n\n                        Craft.postActionRequest('utilities/asset-index-perform-action', {params: params}, function(response) {\n                            if (response.indexingData) {\n                                this.sessionId = response.indexingData.sessionId;\n\n                                // Load up all the data\n                                for (var i = 0; i < response.indexingData.volumes.length; i++) {\n                                    var volumeData = response.indexingData.volumes[i];\n\n                                    for (var requestCounter = 0; requestCounter < volumeData.total; requestCounter++) {\n                                        this.queue.push({\n                                            process: true,\n                                            sessionId: this.sessionId,\n                                            volumeId: volumeData.volumeId,\n                                            cacheImages: this.cacheImages\n                                        });\n                                        this.totalActions++;\n                                    }\n                                }\n\n                                if (this.totalActions > 0) {\n                                    this.processIndexing();\n                                } else {\n                                    this.finishIndexing();\n                                }\n                            }\n                        }.bind(this));\n                    }, this)\n                });\n\n                if (this.$allDone) {\n                    this.$allDone.css('opacity', 0);\n                }\n\n                this.$trigger.addClass('disabled');\n                this.$trigger.trigger('blur');\n            }\n        },\n\n        updateProgressBar: function() {\n            this.progressBar.setItemCount(this.totalActions);\n            this.progressBar.setProcessedItemCount(this.completedActions);\n            this.progressBar.updateProgressBar();\n        },\n\n        processIndexing: function() {\n            if (this.completedActions + this.loadingActions < this.totalActions && this.loadingActions < Craft.AssetIndexesUtility.maxConcurrentActions) {\n                this.loadingActions++;\n\n                var params = this.queue.shift();\n                Craft.postActionRequest('utilities/asset-index-perform-action', {params: params}, function(response) {\n                    this.loadingActions--;\n                    this.completedActions++;\n\n                    this.updateProgressBar();\n\n                    if (response && response.error) {\n                        alert(response.error);\n                    }\n\n                    if (this.completedActions == this.totalActions) {\n                        this.finishIndexing();\n                    } else {\n                        this.processIndexing();\n                    }\n                }.bind(this));\n\n                // Try again, in case we have more space.\n                this.processIndexing();\n            }\n        },\n\n        showConfirmDialog: function(data) {\n            var $modal = $('<form class=\"modal fitted confirmmodal\"/>').appendTo(Garnish.$bod),\n                $body = $('<div class=\"body\"/>').appendTo($modal).html(data.confirm),\n                $footer = $('<footer class=\"footer\"/>').appendTo($modal),\n                $buttons = $('<div class=\"buttons right\"/>').appendTo($footer);\n\n            if (data.showDelete) {\n                let $cancelBtn = $('<button/>', {\n                    type: 'button',\n                    class: 'btn',\n                    text: Craft.t('app', 'Keep them'),\n                }).appendTo($buttons);\n                $('<button/>', {\n                    type: 'submit',\n                    class: 'btn submit',\n                    text: Craft.t('app', 'Delete them'),\n                }).appendTo($buttons);\n\n                this.addListener($cancelBtn, 'click', function() {\n                    modal.hide();\n                    this.onComplete();\n                });\n            } else {\n                $('<button/>', {\n                    type: 'submit',\n                    class: 'btn submit',\n                    text: Craft.t('app', 'OK'),\n                }).appendTo($buttons);\n            }\n\n            Craft.initUiElements($body);\n\n            var modal = new Garnish.Modal($modal, {\n                hideOnEsc: false,\n                hideOnShadeClick: false,\n                onHide: $.proxy(this, 'onActionResponse')\n            });\n\n            this.addListener($modal, 'submit', function(ev) {\n                ev.preventDefault();\n\n                modal.settings.onHide = $.noop;\n                modal.hide();\n\n                var postData = Garnish.getPostData($body);\n                var params = Craft.expandPostArray(postData);\n\n                $.extend(params, data.params);\n                params.finish = true;\n\n                Craft.postActionRequest('utilities/asset-index-perform-action', {params: params}, $.noop);\n                this.onComplete();\n            });\n        },\n\n        finishIndexing: function() {\n            var params = {\n                sessionId: this.sessionId,\n                overview: true\n            };\n\n            Craft.postActionRequest('utilities/asset-index-perform-action', {params: params}, function(response) {\n                if (response.confirm) {\n                    this.hideProgressBar();\n                    this.showConfirmDialog(response);\n                } else {\n                    this.onComplete();\n                }\n            }.bind(this));\n        },\n\n        hideProgressBar: function() {\n            this.progressBar.$progressBarStatus.addClass('hidden');\n            this.progressBar.$progressBar.velocity({opacity: 0}, {\n                duration: 'fast'\n            });\n        },\n\n        onComplete: function() {\n            this.hideProgressBar();\n\n            if (!this.$allDone) {\n                this.$allDone = $('<div class=\"alldone\" data-icon=\"done\" />').appendTo(this.$status);\n                this.$allDone.css('opacity', 0);\n                this.$allDone.velocity({opacity: 1}, {duration: 'fast'});\n                this.$trigger.removeClass('disabled');\n                this.$trigger.trigger('focus');\n            }\n        }\n    }, {\n        maxConcurrentActions: 3\n    });\n})(jQuery);\n"]}