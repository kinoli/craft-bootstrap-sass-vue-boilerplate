{"version":3,"sources":["pluginstoreoauth/src/PluginStoreOauthCallback.js"],"names":["$","Craft","PluginStoreOauthCallback","Garnish","Base","extend","$graphic","$status","errorDetails","data","settings","init","setSettings","this","error","postActionRequest","setTimeout","errorMsg","message","location","html","proxy","window","redirectUrl","response","hash","substr","fragments","fragmentString","updateStatus","textStatus","jqXHR","addClass","getCpUrl","showFatalError","showError","msg","t","escapeHtml","statusText","responseText","$buttonContainer","encodeURIComponent","statusHtml","appendTo","$cancelBtn","class","href","text","$retryBtn","getActionUrl","jQuery"],"mappings":"CAAA,SAACA,GACGC,MAAMC,yBAA2BC,QAAQC,KAAKC,OAAO,CACjDC,SADiD,KAEjDC,QAFiD,KAGjDC,aAHiD,KAI7CC,KAJ6C,KAKjDC,SALiD,KAQ7CC,KAAKC,SAAYF,GAOT,GALHJ,KAAAA,YAAaI,GAAlBG,KAAKP,SAAWN,EAAE,YAGba,KAAKH,QAASI,EAAAA,WAENC,KAAAA,SAAAA,MAIJR,CAELS,IAAYC,EAAOJ,KAAAH,SAAWQ,QAAAL,KAAAH,SAAAQ,QAAAL,KAAAH,SAAAI,MACpBD,KAACM,QAAWC,KAAKV,GAE9BM,WAAAhB,EAAAqB,OAAA,WAxB4CC,OAAAH,SAAAN,KAAAH,SAAAa,cA2BjDR,MAAmB,UAbDC,WAAVhB,EAAAqB,OAAA,WAGGR,KAAAE,sBACCE,MAAW,MAcfF,kBAAkB,WACd,IAAIS,EAAgBF,OAAAH,SAAAM,KAAAC,OAAA,GAChBC,EAAeH,EAAAA,oBAAfI,GAEA3B,MAAK4B,kBAAa,0BAAuBF,EAAgB3B,EAAzDqB,OAAA,SAAAG,EAAAM,EAAAC,GACA,WAAKzB,EAJLkB,EAASV,MAOGD,KAACQ,UAAMG,EAAWV,QAEfK,KAAAA,aAAgBT,MAASa,MAAAA,EAAAA,MAAhC,cAAA,QACGV,KAAAP,SAAA0B,SAAA,WAGDhB,WANVhB,EAAAqB,OAAA,gBAOH,IAAAR,KAAAH,SAAAa,YACED,OAAAH,SAAAN,KAAAH,SAAAa,YAEND,OAAAH,SAAAlB,MAAAgC,SAAA,kBAlDwCpB,MAAA,MAwD/BA,KACVqB,eAAgBH,KAzDyBlB,QAAAqB,eAAA,SAAAH,GAiFjDI,KAAW7B,SAAS8B,SAAK,SAChB9B,IAAAA,EACAuB,MAAa5B,MAAAoC,EAAQD,MAAM,+BAA3BP,4DAIkB5B,MAAAoC,EAAA,MAAA,WAAA,aAAApC,MAAAqC,WAAAP,EAAAQ,YAJlBV,+BAIkB5B,MAAAoC,EAAA,MAAA,aAAA,aAAApC,MAAAqC,WAAAP,EAAAS,cAJlBX,iFAQOY,mBAJZ,wBAMS,SAAIC,mBACT,0GAEMX,EAAAQ,WAFN,iBAGQE,EAJZD,cA7FR,KADJvC,MAAAoC,EAAA,MAAA,iBAyEgB,OAEJxB,KAAKgB,aAAac,IAGtBd,aAAc,SAAST,GACnBP,KAAKN,QAAQa,KAAKA,IAGtBe,UAAW,SAASC,GAChBvB,KAAKP,SAAS0B,SAAS,SACvBnB,KAAKgB,aAAa,MAAQO,EAAM,QAEhC,IAAIK,EAAmBzC,EAAE,gCAAgC4C,SAAS/B,KAAKN,SAEvEsC,WAAa7C,EAAE,OAAQ,CACnB8C,MAAS,UACTC,KAAQ9C,MAAMgC,SAAS,gBACvBe,KAAM,WACPJ,SAASH,GAEZQ,UAAYjD,EAAE,OAAQ,CAClB8C,MAAS,UACTC,KAAQ9C,MAAMiD,aAAa,wBAC3BF,KAAM,cACPJ,SAASH,MAlGxB,CAqGGU","file":"PluginStoreOauthCallback.min.js","sourcesContent":["(function($) {\n    Craft.PluginStoreOauthCallback = Garnish.Base.extend({\n        $graphic: null,\n        $status: null,\n        errorDetails: null,\n        data: null,\n        settings: null,\n\n        init: function(settings) {\n            this.setSettings(settings);\n\n            this.$graphic = $('#graphic');\n            this.$status = $('#status');\n\n            if (!this.settings.error) {\n                setTimeout($.proxy(function() {\n                    this.postActionRequest();\n                }, this), 500);\n            } else {\n                var errorMsg = this.settings.message ? this.settings.message : this.settings.error;\n                this.$status.html(errorMsg);\n\n                setTimeout($.proxy(function() {\n                    window.location = this.settings.redirectUrl;\n                }, this), 1000)\n            }\n        },\n\n        postActionRequest: function() {\n            var fragmentString = window.location.hash.substr(1);\n            var fragments = $.parseFragmentString(fragmentString);\n\n            Craft.postActionRequest('plugin-store/save-token', fragments, $.proxy(function(response, textStatus, jqXHR) {\n                if (textStatus == 'success') {\n                    if (response.error) {\n                        this.showError(response.error);\n                    } else {\n                        this.updateStatus('<p>' + Craft.t('app', 'Connected!') + '</p>');\n                        this.$graphic.addClass('success');\n\n                        // Redirect to the Dashboard in half a second\n                        setTimeout($.proxy(function() {\n                            if (typeof (this.settings.redirectUrl) != 'undefined') {\n                                window.location = this.settings.redirectUrl;\n                            } else {\n                                window.location = Craft.getCpUrl('plugin-store');\n                            }\n                        }, this), 500);\n                    }\n                } else {\n                    this.showFatalError(jqXHR);\n                }\n            }, this));\n        },\n\n        showFatalError: function(jqXHR) {\n            this.$graphic.addClass('error');\n            var statusHtml =\n                '<p>' + Craft.t('app', 'A fatal error has occurred:') + '</p>' +\n                '<div id=\"error\" class=\"code\">' +\n                '<p><strong class=\"code\">' + Craft.t('app', 'Status:') + '</strong> ' + Craft.escapeHtml(jqXHR.statusText) + '</p>' +\n                '<p><strong class=\"code\">' + Craft.t('app', 'Response:') + '</strong> ' + Craft.escapeHtml(jqXHR.responseText) + '</p>' +\n                '</div>' +\n                '<a class=\"btn submit big\" href=\"mailto:support@craftcms.com' +\n                '?subject=' + encodeURIComponent('Craft update failure') +\n                '&body=' + encodeURIComponent(\n                'Describe what happened here.\\n\\n' +\n                '-----------------------------------------------------------\\n\\n' +\n                'Status: ' + jqXHR.statusText + '\\n\\n' +\n                'Response: ' + jqXHR.responseText\n                ) +\n                '\">' +\n                Craft.t('app', 'Send for help') +\n                '</a>';\n\n            this.updateStatus(statusHtml);\n        },\n\n        updateStatus: function(html) {\n            this.$status.html(html);\n        },\n\n        showError: function(msg) {\n            this.$graphic.addClass('error');\n            this.updateStatus('<p>' + msg + '</p>');\n\n            var $buttonContainer = $('<div id=\"junction-buttons\"/>').appendTo(this.$status);\n\n            $cancelBtn = $('<a/>', {\n                'class': 'btn big',\n                'href': Craft.getCpUrl('plugin-store'),\n                text: \"Cancel\",\n            }).appendTo($buttonContainer);\n\n            $retryBtn = $('<a/>', {\n                'class': 'btn big',\n                'href': Craft.getActionUrl('plugin-store/connect'),\n                text: \"Try again\",\n            }).appendTo($buttonContainer);\n        }\n    });\n})(jQuery);\n"]}